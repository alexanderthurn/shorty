<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Shorty Dashboard v3.1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f4f7f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
        }

        th {
            background: #2d3748;
            color: white;
            font-weight: 600;
        }

        .row-done {
            background-color: #f0fff4;
            opacity: 0.8;
        }

        .row-next {
            background-color: #fffaf0 !important;
            border: 2px solid #ed8936;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }

        .bg-ok {
            background: #c6f6d5;
            color: #22543d;
        }

        .bg-err {
            background: #fed7d7;
            color: #822727;
        }

        .btn {
            cursor: pointer;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            background: #3182ce;
            color: white;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2b6cb0;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .yt-link {
            color: #e53e3e;
            font-weight: bold;
            text-decoration: none;
        }

        .sheet-link {
            color: #2b6cb0;
            text-decoration: none;
        }

        .sheet-link:hover {
            text-decoration: underline;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .modal-close {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #2b6cb0;
        }

        #password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(3px);
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <h2 id="status-text">Upload lÃ¤uft...</h2>
        <p>Bitte das Tab nicht schlieÃŸen.</p>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Hinweis</h2>
            <p id="modal-message"></p>
            <button class="modal-close" onclick="closeModal()">OK</button>
        </div>
    </div>

    <div id="password-modal">
        <div class="modal-content">
            <h2>ðŸ”‘ Autorisierung</h2>
            <p>Bitte Passwort fÃ¼r Upload eingeben:</p>
            <input type="password" id="upload-password" class="password-input" placeholder="Passwort...">
            <div class="btn-group">
                <button class="modal-close btn-cancel" onclick="closePasswordModal()">Abbrechen</button>
                <button class="modal-close" id="confirm-upload-btn">Upload starten</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>ðŸš€ Bitcoin Jahr 2026 Manager</h1>
        <div id="content">Daten werden geladen...</div>
    </div>

    <script>
        async function loadData() {
            const content = document.getElementById('content');
            try {
                const response = await fetch('list.php');
                const json = await response.json();

                let html = `<table><thead><tr><th>Nr</th><th>Titel (Sheet)</th><th>Plan-Datum</th><th>Drive-Files</th><th>YouTube</th><th>Aktion</th></tr></thead><tbody>`;

                const nextPending = [...json.data].reverse().find(item => !item.isUploaded);
                let scrolled = false;

                json.data.forEach(item => {
                    const isDone = item.isUploaded;
                    const isNext = nextPending && item.nr === nextPending.nr;
                    if (isNext) scrolled = true;

                    const mp4Badge = item.hasMp4
                        ? `<a href="${item.mp4Link}" target="_blank" class="badge bg-ok">MP4 âœ”</a>`
                        : `<span class="badge bg-err">MP4 âœ˜</span>`;

                    const srtBadge = item.hasSrt
                        ? `<a href="${item.srtLink}" target="_blank" class="badge bg-ok">SRT âœ”</a>`
                        : `<span class="badge bg-err">SRT âœ˜</span>`;

                    html += `<tr class="${isDone ? 'row-done' : (isNext ? 'row-next' : '')}" ${isNext ? 'id="next-video"' : ''}>
                <td><strong>#${item.nr}</strong></td>
                <td><a href="${item.sheetLink}" target="_blank" class="sheet-link">${item.titel}</a></td>
                <td>${item.datum}</td>
                <td>${mp4Badge} ${srtBadge}</td>
                <td>
                    ${isDone ? `<a href="https://youtu.be/${item.youtubeId}" target="_blank" class="yt-link">ðŸŽ¬ Video</a>` : 'Ausstehend'}
                </td>
                <td>
                    <button class="btn" onclick="runUpload(${item.nr})" ${item.youtubeId || !item.hasMp4 ? 'disabled' : ''}>
                        Upload
                    </button>
                </td>
            </tr>`;
                });

                content.innerHTML = html + '</tbody></table>';

                if (scrolled) {
                    document.getElementById('next-video').scrollIntoView({ behavior: 'auto', block: 'center' });
                }

            } catch (e) { content.innerHTML = "Fehler beim Laden: " + e.message; }
        }

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('upload-password').value = '';
        }

        function runUpload(nr) {
            const modal = document.getElementById('password-modal');
            const input = document.getElementById('upload-password');
            const btn = document.getElementById('confirm-upload-btn');

            modal.style.display = 'flex';
            input.focus();

            // Click handler setup
            btn.onclick = () => {
                const password = input.value;
                if (!password) return;
                closePasswordModal();
                executeUpload(nr, password);
            };

            // Enter key support
            input.onkeydown = (e) => {
                if (e.key === 'Enter') btn.click();
            };
        }

        async function executeUpload(nr, password) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            document.getElementById('status-text').innerText = `Video #${nr} wird an YouTube Ã¼bertragen...`;

            try {
                const fd = new FormData();
                fd.append('video_num', nr);
                fd.append('password', password);

                const res = await fetch('upload.php', { method: 'POST', body: fd });
                const data = await res.json();

                if (data.success) {
                    showModal("Erfolg!", `Video #${nr} wurde hochgeladen und geplant.`);
                    loadData();
                } else {
                    showModal("Fehler beim Upload", data.message);
                }
            } catch (e) {
                showModal("Fehler", "Netzwerkfehler oder Server-Timeout.");
            } finally {
                overlay.style.display = 'none';
            }
        }

        loadData();
    </script>
</body>

</html>