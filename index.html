<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorty Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f4f7f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            display: inline-block;
            margin-right: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
        }

        th {
            background: #2d3748;
            color: white;
            font-weight: 600;
        }

        .row-done {
            background-color: #f0fff4;
            opacity: 0.8;
        }

        .row-next {
            background-color: #fffaf0 !important;
            border: 2px solid #ed8936;
        }

        .row-today {
            background-color: #ebf8ff !important;
            border-left: 5px solid #3182ce !important;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }

        .bg-ok {
            background: #c6f6d5;
            color: #22543d;
        }

        .bg-err {
            background: #fed7d7;
            color: #822727;
        }

        .btn {
            cursor: pointer;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #3182ce;
            color: white;
            font-weight: bold;
            transition: background 0.2s;
            font-size: 0.85rem;
        }

        .btn:hover {
            background: #2b6cb0;
        }

        .btn-refresh {
            background: #38a169;
        }

        .btn-refresh:hover {
            background: #2f855a;
        }

        .btn:disabled {
            background: #cbd5e0 !important;
            color: #718096 !important;
            cursor: not-allowed;
        }

        .btn-x-post {
            background: #000;
        }

        .btn-x-post:hover:not(:disabled) {
            background: #333;
        }

        .btn-x-ref {
            background: #3182ce;
        }

        .btn-x-ref:hover:not(:disabled) {
            background: #2b6cb0;
        }

        .action-cell {
            display: flex;
            gap: 5px;
        }

        .bulk-actions {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .bulk-actions span {
            font-weight: bold;
            color: #4a5568;
        }

        .bulk-actions .btn-x {
            background: #000;
            color: white;
        }

        .bulk-actions .btn-x:hover {
            background: #333;
        }

        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .project-selector-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #project-select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e0;
            font-size: 1rem;
            background: white;
        }

        .btn-logout {
            background: #e53e3e;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-logout:hover {
            background: #c53030;
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .info-cell {
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .links-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .links-cell a {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Mobile Optimierungen */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0;
            }

            .header-area {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            h1 {
                margin-right: 0;
            }

            .bulk-actions {
                flex-direction: column;
                position: static;
                gap: 10px;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                display: none;
            }

            tr {
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 15px;
                background: white !important;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            td:before {
                display: none;
            }

            td {
                border-bottom: none;
                padding: 4px 0;
                display: block;
                text-align: center;
            }

            /* Verstecke Spalten auf Mobile */
            td[data-label="Nr"],
            td[data-label="Auswahl"],
            .checkbox-col {
                display: none;
            }

            .action-cell {
                display: flex !important;
                flex-direction: row !important;
                gap: 5px;
                padding-top: 10px !important;
                justify-content: center;
                margin-top: 5px;
                border-top: 1px solid #edf2f7;
            }

            .action-cell .btn {
                flex: 1;
                width: auto;
                padding: 8px 2px;
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            td[data-label="Datum"] {
                font-size: 0.85rem;
                color: #4a5568;
            }

            td[data-label="Titel"] {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                font-size: 1.15rem;
                margin-bottom: 5px;
            }

            td[data-label="Titel"]:before {
                margin-bottom: 5px;
            }

            .modal-content {
                width: 90%;
                padding: 20px;
            }
        }

        .yt-link {
            color: #e53e3e;
            font-weight: bold;
            text-decoration: none;
        }

        .sheet-link {
            color: #2b6cb0;
            text-decoration: none;
        }

        .sheet-link:hover {
            text-decoration: underline;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .modal-close {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #2b6cb0;
        }

        #password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(3px);
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        /* Wide Modal for Previews */
        .wide-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            /* Scrollable if too long */
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: left;
        }

        .preview-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .preview-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .preview-field {
            margin-bottom: 8px;
        }

        .preview-label {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
            font-weight: bold;
        }

        .preview-val {
            white-space: pre-wrap;
            font-family: monospace;
            background: white;
            padding: 8px;
            border: 1px solid #edf2f7;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <h2 id="status-text">Upload l√§uft...</h2>
        <p>Bitte das Tab nicht schlie√üen.</p>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Hinweis</h2>
            <div id="modal-message"></div>
            <div style="text-align:center; margin-top:20px;">
                <button class="modal-close" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <div id="wide-modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2100; justify-content:center; align-items:center; backdrop-filter:blur(3px);">
        <div class="wide-modal-content">
            <h2 id="wide-modal-title" style="margin-top:0;">Preview</h2>
            <div id="wide-modal-body"></div>
            <div style="text-align:right; margin-top:20px;">
                <button class="modal-close"
                    onclick="document.getElementById('wide-modal-overlay').style.display='none'">Schlie√üen</button>
            </div>
        </div>
    </div>

    <div id="password-modal">
        <div class="modal-content">
            <h2>üîë Autorisierung</h2>
            <p>Bitte Passwort f√ºr Upload eingeben:</p>
            <input type="password" id="upload-password" class="password-input" placeholder="Passwort...">
            <div class="btn-group">
                <button class="modal-close btn-cancel" onclick="closePasswordModal()">Abbrechen</button>
                <button class="modal-close" id="confirm-upload-btn">Upload starten</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-area">
            <h1>üöÄ Shorty Manager</h1>

            <div class="project-selector-container">
                <select id="project-select" onchange="changeProject(this.value)">
                    <option value="" disabled selected>Projekt w√§hlen...</option>
                </select>
                <button class="btn btn-logout" id="logout-btn" style="display:none;" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="bulk-actions" id="bulk-bar" style="display:none;">
            <span id="selected-count">0 Videos ausgew√§hlt</span>
            <button class="btn" onclick="runBulkAction('upload')">Bulk YT Short</button>
            <button class="btn btn-refresh" onclick="runBulkAction('refresh')">Bulk YouTube Refresh</button>
            <button class="btn btn-x" onclick="runBulkAction('x_post')">Bulk X Post</button>
            <button class="btn btn-secondary" style="background:#805ad5;" onclick="runBulkPreview('youtube')">YT
                Preview</button>
            <button class="btn btn-secondary" style="background:#d53f8c;" onclick="runBulkPreview('x_post')">X
                Preview</button>
            <button class="btn btn-cancel" onclick="deselectAll()" style="padding: 8px 12px;">Auswahl aufheben</button>
        </div>

        <div id="content">Bitte w√§hle ein Projekt aus.</div>
    </div>

    <script>
        // Helper: SHA-256 Hash erzeugen
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function logout() {
            localStorage.removeItem('upload_pw_hash');
            location.reload();
        }

        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.video-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkBar();
        }

        function deselectAll() {
            document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateBulkBar();
        }

        function updateBulkBar() {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const bar = document.getElementById('bulk-bar');
            const countLabel = document.getElementById('selected-count');

            if (checked.length > 0) {
                bar.style.display = 'flex';
                countLabel.innerText = `${checked.length} Video(s) ausgew√§hlt`;
            } else {
                bar.style.display = 'none';
            }
        }

        function getProjectId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('project');
        }

        function changeProject(projectId) {
            if (projectId) {
                const url = new URL(window.location);
                url.searchParams.set('project', projectId);
                window.history.pushState({}, '', url);
                loadData();
            }
        }

        async function init() {
            // First load projects list to populate dropdown
            try {
                const response = await fetch('list.php');
                const json = await response.json();

                if (json.mode === 'project_list') {
                    const select = document.getElementById('project-select');
                    select.innerHTML = '<option value="" disabled selected>Projekt w√§hlen...</option>';

                    json.projects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.title;
                        select.appendChild(opt);
                    });

                    // Check URL for current project
                    let currentProject = getProjectId();

                    // If no project in URL, check for default
                    if (!currentProject && json.default_project) {
                        currentProject = json.default_project;
                        // Update URL without reloading
                        const url = new URL(window.location);
                        url.searchParams.set('project', currentProject);
                        window.history.replaceState({}, '', url);
                    }

                    if (currentProject) {
                        select.value = currentProject;
                        loadData(); // Load data if project already in URL or default found
                    }
                }
            } catch (e) {
                document.getElementById('content').innerHTML = "Fehler beim Laden der Projekte: " + e.message;
            }

            // Logout Button visibility
            document.getElementById('logout-btn').style.display = localStorage.getItem('upload_pw_hash') ? 'block' : 'none';
        }

        async function loadData() {
            const projectId = getProjectId();
            if (!projectId) return;

            const content = document.getElementById('content');
            content.innerHTML = "Daten werden geladen...";

            try {
                const response = await fetch(`list.php?project=${projectId}`);
                const json = await response.json();

                if (!json.success) {
                    content.innerHTML = `<div style="color:red; text-align:center;">${json.error}</div>`;
                    return;
                }

                // Update UI Title
                document.querySelector('h1').innerText = "üöÄ " + json.project_title;
                document.title = json.project_title + " - Shorty";

                const nextPending = [...json.data].reverse().find(item => !item.isUploaded);
                let scrolled = false;

                const todayStr = new Date().toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                let html = `<table><thead><tr>
                    <th class="checkbox-col"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                    <th>Nr</th><th>Titel (Sheet)</th><th>Info / Dateien</th><th>Links</th><th>Aktion</th>
                </tr></thead><tbody>`;

                json.data.forEach(item => {
                    const isDone = item.isUploaded;
                    const isNext = nextPending && item.nr === nextPending.nr;
                    if (isNext) scrolled = true;

                    const mp4Badge = item.hasMp4
                        ? `<a href="${item.mp4Link}" target="_blank" class="badge bg-ok">MP4 ‚úî</a>`
                        : `<span class="badge bg-err">MP4 ‚úò</span>`;

                    const srtBadge = item.hasSrt
                        ? `<a href="${item.srtLink}" target="_blank" class="badge bg-ok">SRT ‚úî</a>`
                        : `<span class="badge bg-err">SRT ‚úò</span>`;

                    const isToday = item.datum.startsWith(todayStr);

                    let rowClass = '';
                    if (isToday) rowClass = 'row-today';
                    else if (isDone) rowClass = 'row-done';
                    else if (isNext) rowClass = 'row-next';

                    html += `<tr class="${rowClass}" ${isNext ? 'id="next-video"' : ''}>
                <td class="checkbox-col" data-label="Auswahl"><input type="checkbox" class="video-checkbox" value="${item.nr}" onchange="updateBulkBar()"></td>
                <td data-label="Nr"><strong>#${item.nr}</strong></td>
                <td data-label="Titel"><a href="${item.sheetLink}" target="_blank" class="sheet-link">${item.titel}</a></td>
                <td data-label="Info" class="info-cell">
                    <div>${item.datum}</div>
                    <div style="margin-top:4px;">${mp4Badge} ${srtBadge}</div>
                </td>
                <td data-label="Links" class="links-cell">
                    ${item.youtubeId ? `<a href="https://youtu.be/${item.youtubeId}" target="_blank" class="yt-link">üé¨ Video</a>` : ''}
                    ${item.xTweetId ? `<a href="https://x.com/i/status/${item.xTweetId}" target="_blank" class="sheet-link">üê¶ Tweet</a>` : ''}
                </td>
                <td class="action-cell" data-label="Aktionen">
                    <button class="btn" onclick="runAction(${item.nr}, 'upload')" ${item.youtubeId || !item.hasMp4 ? 'disabled' : ''} title="Upload to YouTube">
                        YT Short
                    </button>
                    <button class="btn btn-refresh" onclick="runAction(${item.nr}, 'refresh')" ${!item.youtubeId ? 'disabled' : ''} title="Refresh YouTube Metadata">
                        YT Ref
                    </button>
                    <button class="btn ${item.xMediaId ? 'btn-x-ref' : 'btn-x-post'}" 
                            onclick="runAction(${item.nr}, 'x_post')" 
                            ${item.xTweetId || !item.hasMp4 ? 'disabled' : ''} 
                            title="${item.xMediaId ? 'X Video wird noch verarbeitet - klicken zum Pr√ºfen' : 'Post to X (Twitter)'}">
                        ${item.xMediaId ? 'X Ref' : 'X Post'}
                    </button>
                </td>
            </tr>`;
                });

                content.innerHTML = html + '</tbody></table>';

                if (scrolled) {
                    document.getElementById('next-video').scrollIntoView({ behavior: 'auto', block: 'center' });
                }

            } catch (e) { content.innerHTML = "Fehler beim Laden: " + e.message; }
        }

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            // Allow HTML in message if needed, but usually innerText is safer. 
            // Here we changed the p to div in HTML structure above, so let's stick to innerHTML if we want formatting, or innerText.
            // But 'showModal' is legacy. Let's support both.
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('upload-password').value = '';
        }

        async function getAuthHash() {
            let hash = localStorage.getItem('upload_pw_hash');
            if (hash) return hash;

            return new Promise((resolve) => {
                const modal = document.getElementById('password-modal');
                const input = document.getElementById('upload-password');
                const btn = document.getElementById('confirm-upload-btn');

                modal.style.display = 'flex';
                input.focus();

                const handler = async () => {
                    const password = input.value;
                    if (!password) return;

                    const hashed = await sha256(password);
                    localStorage.setItem('upload_pw_hash', hashed);

                    closePasswordModal();
                    document.getElementById('logout-btn').style.display = 'block';

                    btn.removeEventListener('click', handler);
                    input.removeEventListener('keydown', keyHandler);
                    resolve(hashed);
                };

                const keyHandler = (e) => {
                    if (e.key === 'Enter') handler();
                };

                btn.addEventListener('click', handler);
                input.addEventListener('keydown', keyHandler);
            });
        }

        async function runBulkAction(type) {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            if (ids.length === 0) return;

            const hash = await getAuthHash();
            if (!hash) return;

            const projectId = getProjectId();
            if (!projectId) return;

            // Bulk Execution one by one
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            for (let i = 0; i < ids.length; i++) {
                const nr = ids[i];
                document.getElementById('status-text').innerText = `[${i + 1}/${ids.length}] Video #${nr} wird verarbeitet...`;

                try {
                    const fd = new FormData();
                    fd.append('video_num', nr);
                    fd.append('password', hash);
                    fd.append('project', projectId);

                    const endpointMap = {
                        'upload': 'upload.php',
                        'refresh': 'refresh.php',
                        'x_post': 'x_post.php'
                    };
                    const res = await fetch(endpointMap[type], { method: 'POST', body: fd });
                    const data = await res.json();

                    if (!data.success) {
                        showModal("Abbruch w√§hrend Bulk", `Fehler bei Video #${nr}: ` + data.message);
                        break;
                    }
                } catch (e) {
                    showModal("Netzwerkfehler", `Abbruch bei Video #${nr}`);
                    break;
                }
            }

            overlay.style.display = 'none';
            deselectAll();
            loadData();
            showModal("Bulk Fertig", `${ids.length} Videos wurden verarbeitet.`);
        }

        async function runBulkPreview(type) {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            if (ids.length === 0) return;

            const hash = await getAuthHash();
            if (!hash) return;

            const projectId = getProjectId();
            if (!projectId) return;

            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            document.getElementById('status-text').innerText = "Generiere Preview...";

            const endpoint = (type === 'youtube') ? 'upload.php' : 'x_post.php';
            let html = "";

            for (let i = 0; i < ids.length; i++) {
                const nr = ids[i];
                try {
                    const fd = new FormData();
                    fd.append('video_num', nr);
                    fd.append('password', hash);
                    fd.append('project', projectId);
                    fd.append('preview', 'true'); // Flag for preview

                    const res = await fetch(endpoint, { method: 'POST', body: fd });
                    const data = await res.json();

                    if (data.success && data.preview) {
                        html += `<div class="preview-item">
                            <div class="preview-header">Video #${data.videoNum} Preview (${type})</div>`;

                        if (data.driveLink) {
                            html += `<div class="preview-field"><a href="${data.driveLink}" target="_blank" style="color:#3182ce; font-weight:bold;">üìΩÔ∏è Google Drive Video Link</a></div>`;
                        } else {
                            html += `<div class="preview-field" style="color:red;">Link nicht gefunden</div>`;
                        }

                        if (data.title) {
                            html += `<div class="preview-field"><div class="preview-label">Titel</div><div class="preview-val">${data.title}</div></div>`;
                        }
                        if (data.desc) {
                            html += `<div class="preview-field"><div class="preview-label">Beschreibung</div><div class="preview-val">${data.desc}</div></div>`;
                        }
                        if (data.tags) {
                            html += `<div class="preview-field"><div class="preview-label">Tags</div><div class="preview-val">${Array.isArray(data.tags) ? data.tags.join(', ') : data.tags}</div></div>`;
                        }
                        if (data.full_text) {
                            html += `<div class="preview-field"><div class="preview-label">Tweet Text</div><div class="preview-val">${data.full_text}</div></div>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<div class="preview-item" style="color:red;">Fehler bei Video #${nr}: ${data.message}</div>`;
                    }

                } catch (e) {
                    html += `<div class="preview-item" style="color:red;">Netzwerkfehler bei Video #${nr}</div>`;
                }
            }

            overlay.style.display = 'none';
            document.getElementById('wide-modal-title').innerText = (type === 'youtube' ? 'YouTube' : 'X (Twitter)') + ' Preview';
            document.getElementById('wide-modal-body').innerHTML = html;
            document.getElementById('wide-modal-overlay').style.display = 'flex';
        }

        async function runAction(nr, type) {
            const hash = await getAuthHash();
            if (!hash) return;
            executeAction(nr, hash, type);
        }

        async function executeAction(nr, hash, type) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            const actionText = {
                'upload': 'wird an YouTube √ºbertragen...',
                'refresh': 'Metadaten werden aktualisiert...',
                'x_post': 'wird auf X gepostet...'
            };
            document.getElementById('status-text').innerText = `Video #${nr} ${actionText[type]}`;

            const projectId = getProjectId();

            try {
                const fd = new FormData();
                fd.append('video_num', nr);
                fd.append('password', hash);
                fd.append('project', projectId);

                const endpointMap = {
                    'upload': 'upload.php',
                    'refresh': 'refresh.php',
                    'x_post': 'x_post.php'
                };
                const res = await fetch(endpointMap[type], { method: 'POST', body: fd });
                const data = await res.json();

                if (data.success) {
                    showModal("Erfolg!", data.message || `Video #${nr} wurde verarbeitet.`);
                    loadData();
                } else {
                    showModal("Fehler", data.message);
                    if (data.message.includes("Passwort")) {
                        localStorage.removeItem('upload_pw_hash');
                        location.reload();
                    }
                }
            } catch (e) {
                showModal("Fehler", "Netzwerkfehler oder Server-Timeout.");
            } finally {
                overlay.style.display = 'none';
            }
        }

        init();
    </script>
</body>

</html>