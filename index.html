<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorty Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f4f7f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            display: inline-block;
            margin-right: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
        }

        th {
            background: #2d3748;
            color: white;
            font-weight: 600;
        }

        .row-done {
            background-color: #f0fff4;
            opacity: 0.8;
        }

        .row-next {
            background-color: #fffaf0 !important;
            border: 2px solid #ed8936;
        }

        .row-today {
            background-color: #ebf8ff !important;
            border-left: 5px solid #3182ce !important;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }

        .bg-ok {
            background: #c6f6d5;
            color: #22543d;
        }

        .bg-err {
            background: #fed7d7;
            color: #822727;
        }

        .btn {
            cursor: pointer;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #3182ce;
            color: white;
            font-weight: bold;
            transition: background 0.2s;
            font-size: 0.85rem;
        }

        .btn:hover {
            background: #2b6cb0;
        }

        .btn-refresh {
            background: #38a169;
        }

        .btn-refresh:hover {
            background: #2f855a;
        }

        .btn:disabled {
            background: #cbd5e0 !important;
            color: #718096 !important;
            cursor: not-allowed;
        }

        .btn-x-post {
            background: #000;
        }

        .btn-x-post:hover:not(:disabled) {
            background: #333;
        }

        .btn-x-ref {
            background: #3182ce;
        }

        .btn-x-ref:hover:not(:disabled) {
            background: #2b6cb0;
        }

        .action-cell {
            display: flex;
            gap: 5px;
        }

        .bulk-actions {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .bulk-actions span {
            font-weight: bold;
            color: #4a5568;
        }

        .bulk-actions .btn-x {
            background: #000;
            color: white;
        }

        .bulk-actions .btn-x:hover {
            background: #333;
        }

        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .project-selector-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #project-select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e0;
            font-size: 1rem;
            background: white;
        }

        .btn-logout {
            background: #e53e3e;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-logout:hover {
            background: #c53030;
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .info-cell {
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .links-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .links-cell a {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Mobile Optimierungen */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0;
            }

            .header-area {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            h1 {
                margin-right: 0;
            }

            .bulk-actions {
                flex-direction: column;
                position: static;
                gap: 10px;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                display: none;
            }

            tr {
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 15px;
                background: white !important;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            td:before {
                display: none;
            }

            td {
                border-bottom: none;
                padding: 4px 0;
                display: block;
                text-align: center;
            }

            /* Verstecke Spalten auf Mobile */
            td[data-label="Nr"],
            td[data-label="Auswahl"],
            .checkbox-col {
                display: none;
            }

            .action-cell {
                display: flex !important;
                flex-direction: row !important;
                gap: 5px;
                padding-top: 10px !important;
                justify-content: center;
                margin-top: 5px;
                border-top: 1px solid #edf2f7;
            }

            .action-cell .btn {
                flex: 1;
                width: auto;
                padding: 8px 2px;
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            td[data-label="Datum"] {
                font-size: 0.85rem;
                color: #4a5568;
            }

            td[data-label="Titel"] {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                font-size: 1.15rem;
                margin-bottom: 5px;
            }

            td[data-label="Titel"]:before {
                margin-bottom: 5px;
            }

            .modal-content {
                width: 90%;
                padding: 20px;
            }
        }

        .yt-link {
            color: #e53e3e;
            font-weight: bold;
            text-decoration: none;
        }

        .sheet-link {
            color: #2b6cb0;
            text-decoration: none;
        }

        .sheet-link:hover {
            text-decoration: underline;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .modal-close {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #2b6cb0;
        }

        #password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(3px);
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        /* Wide Modal for Previews */
        .wide-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            /* Scrollable if too long */
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: left;
        }

        .preview-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .preview-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .preview-field {
            margin-bottom: 8px;
        }

        .preview-label {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
            font-weight: bold;
        }

        .preview-val {
            white-space: pre-wrap;
            font-family: monospace;
            background: white;
            padding: 8px;
            border: 1px solid #edf2f7;
            border-radius: 4px;
            margin-top: 4px;
            word-break: break-word;
        }

        .preview-metadata {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .preview-metadata .preview-field {
            margin-bottom: 0;
        }

        .preview-metadata .preview-val {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.95rem;
        }

        @media (max-width: 768px) {
            .preview-metadata {
                grid-template-columns: 1fr;
            }
        }

        /* Tweet Styling */
        .tweet-card {
            background: white;
            border: 1px solid #cfd9de;
            border-radius: 12px;
            padding: 12px 16px;
            max-width: 500px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin-bottom: 20px;
        }

        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .tweet-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #cbd5e0;
            margin-right: 12px;
        }

        .tweet-names {
            display: flex;
            flex-direction: column;
        }

        .tweet-name {
            font-weight: bold;
            color: #0f1419;
            font-size: 15px;
        }

        .tweet-handle {
            color: #536471;
            font-size: 15px;
        }

        .tweet-body {
            font-size: 15px;
            color: #0f1419;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 12px;
        }

        .tweet-media {
            border-radius: 12px;
            background: #efefef;
            overflow: hidden;
            border: 1px solid #cfd9de;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .tweet-link {
            color: #1d9bf0;
            text-decoration: none;
        }

        .tweet-link:hover {
            text-decoration: underline;
        }

        .tweet-actions-mock {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            color: #536471;
            font-size: 18px;
            max-width: 80%;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <h2 id="status-text">Upload l√§uft...</h2>
        <p>Bitte das Tab nicht schlie√üen.</p>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Hinweis</h2>
            <div id="modal-message"></div>
            <div style="text-align:center; margin-top:20px;">
                <button class="modal-close" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <div id="wide-modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2100; justify-content:center; align-items:center; backdrop-filter:blur(3px);"
        onclick="if(event.target === this) this.style.display='none'">
        <div class="wide-modal-content" onclick="event.stopPropagation()">
            <h2 id="wide-modal-title" style="margin-top:0;">Preview</h2>
            <div id="wide-modal-body"></div>
            <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="modal-close btn-cancel"
                    onclick="document.getElementById('wide-modal-overlay').style.display='none'">Abbrechen</button>
                <button class="modal-close btn-success" id="wide-modal-confirm">Fortfahren & Ausf√ºhren</button>
            </div>
        </div>
    </div>

    <div id="password-modal">
        <div class="modal-content">
            <h2>üîë Autorisierung</h2>
            <p>Bitte Passwort f√ºr Upload eingeben:</p>
            <input type="password" id="upload-password" class="password-input" placeholder="Passwort...">
            <div class="btn-group">
                <button class="modal-close btn-cancel" onclick="closePasswordModal()">Abbrechen</button>
                <button class="modal-close" id="confirm-upload-btn">Upload starten</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-area">
            <div>
                <h1>üöÄ Shorty Manager</h1>
                <a href="swipe.html" id="swipe-link" class="btn"
                    style="background: #6b46c1; text-decoration: none; vertical-align: middle; margin-top: -5px; display: inline-block;">üì±
                    Swipe View</a>
            </div>

            <div class="project-selector-container">
                <select id="project-select" onchange="changeProject(this.value)">
                    <option value="" disabled selected>Projekt w√§hlen...</option>
                </select>
                <button class="btn btn-logout" id="logout-btn" style="display:none;" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="bulk-actions" id="bulk-bar" style="display:none;">
            <span id="selected-count">0 Videos ausgew√§hlt</span>
            <span id="selected-count">0 Videos ausgew√§hlt</span>
            <button class="btn" onclick="initiateBulkAction('upload')">Bulk YT Short</button>
            <button class="btn btn-refresh" onclick="initiateBulkAction('refresh')">Bulk YouTube Refresh</button>
            <button class="btn btn-x" onclick="initiateBulkAction('x_post')">Bulk X Post</button>
            <button class="btn btn-cancel" onclick="deselectAll()" style="padding: 8px 12px;">Auswahl aufheben</button>
        </div>

        <div id="content">Bitte w√§hle ein Projekt aus.</div>
    </div>

    <script>
        // Helper: SHA-256 Hash erzeugen
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function logout() {
            localStorage.removeItem('upload_pw_hash');
            location.reload();
        }

        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.video-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkBar();
        }

        function deselectAll() {
            document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateBulkBar();
        }

        function updateBulkBar() {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const bar = document.getElementById('bulk-bar');
            const countLabel = document.getElementById('selected-count');

            if (checked.length > 0) {
                bar.style.display = 'flex';
                countLabel.innerText = `${checked.length} Video(s) ausgew√§hlt`;
            } else {
                bar.style.display = 'none';
            }
        }

        function getProjectId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('project');
        }

        function updateSwipeLink(projectId) {
            const link = document.getElementById('swipe-link');
            if (link && projectId) {
                link.href = `swipe.html?project=${projectId}`;
            }
        }

        function changeProject(projectId) {
            if (projectId) {
                const url = new URL(window.location);
                url.searchParams.set('project', projectId);
                window.history.pushState({}, '', url);
                updateSwipeLink(projectId);
                loadData();
            }
        }

        async function init() {
            // First load projects list to populate dropdown
            try {
                const response = await fetch('list.php');
                const json = await response.json();

                if (json.mode === 'project_list') {
                    const select = document.getElementById('project-select');
                    select.innerHTML = '<option value="" disabled selected>Projekt w√§hlen...</option>';

                    json.projects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.title;
                        select.appendChild(opt);
                    });

                    // Check URL for current project
                    let currentProject = getProjectId();

                    // If no project in URL, check for default
                    if (!currentProject && json.default_project) {
                        currentProject = json.default_project;
                        // Update URL without reloading
                        const url = new URL(window.location);
                        url.searchParams.set('project', currentProject);
                        window.history.replaceState({}, '', url);
                    }

                    if (currentProject) {
                        select.value = currentProject;
                        loadData(); // Load data if project already in URL or default found
                    }
                }
            } catch (e) {
                document.getElementById('content').innerHTML = "Fehler beim Laden der Projekte: " + e.message;
            }

            // Logout Button visibility
            document.getElementById('logout-btn').style.display = localStorage.getItem('upload_pw_hash') ? 'block' : 'none';
        }

        async function loadData() {
            const projectId = getProjectId();
            if (!projectId) return;

            const content = document.getElementById('content');
            content.innerHTML = "Daten werden geladen...";

            try {
                const response = await fetch(`list.php?project=${projectId}`);
                const json = await response.json();

                if (!json.success) {
                    if (json.error && json.error.includes("GOOGLE TOKEN EXPIRED")) {
                        content.innerHTML = `<div style="color:red; text-align:center; padding: 20px;">
                            <h3>üîë Authentifizierung erforderlich</h3>
                            <p>${json.error}</p>
                            <a href="auth.php" class="btn">Jetzt neu verbinden</a>
                        </div>`;
                    } else {
                        content.innerHTML = `<div style="color:red; text-align:center;">${json.error}</div>`;
                    }
                    return;
                }

                // Update UI Title
                document.querySelector('h1').innerText = "üöÄ " + json.project_title;
                document.title = json.project_title + " - Shorty";

                const nextPending = [...json.data].reverse().find(item => !item.isUploaded);
                let scrolled = false;

                const todayStr = new Date().toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                let html = `<table><thead><tr>
                    <th class="checkbox-col"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                    <th>Nr</th><th>Titel (Sheet)</th><th>Info / Dateien</th><th>Links</th><th>Aktion</th>
                </tr></thead><tbody>`;

                json.data.forEach(item => {
                    const isDone = item.isUploaded;
                    const isNext = nextPending && item.nr === nextPending.nr;
                    if (isNext) scrolled = true;

                    const mp4Badge = item.hasMp4
                        ? `<a href="${item.mp4Link}" target="_blank" class="badge bg-ok">MP4 ‚úî</a>`
                        : `<span class="badge bg-err">MP4 ‚úò</span>`;

                    const srtBadge = item.hasSrt
                        ? `<a href="${item.srtLink}" target="_blank" class="badge bg-ok">SRT ‚úî</a>`
                        : `<span class="badge bg-err">SRT ‚úò</span>`;

                    const isToday = item.datum.startsWith(todayStr);

                    let rowClass = '';
                    if (isToday) rowClass = 'row-today';
                    else if (isDone) rowClass = 'row-done';
                    else if (isNext) rowClass = 'row-next';

                    html += `<tr class="${rowClass}" ${isNext ? 'id="next-video"' : ''}>
                <td class="checkbox-col" data-label="Auswahl"><input type="checkbox" class="video-checkbox" value="${item.nr}" onchange="updateBulkBar()"></td>
                <td data-label="Nr"><a href="${item.sheetLink}" target="_blank" class="sheet-link"><strong>#${item.nr}</strong></a></td>
                <td data-label="Titel"><a href="#" onclick="showDetails(${item.nr}); return false;" class="sheet-link">${item.titel}</a></td>
                <td data-label="Info" class="info-cell">
                    <div>${item.datum}</div>
                    <div style="margin-top:4px;">${mp4Badge} ${srtBadge}</div>
                </td>
                <td data-label="Links" class="links-cell">
                    ${item.youtubeId ? `<a href="https://youtu.be/${item.youtubeId}" target="_blank" class="yt-link">üé¨ Video</a>` : ''}
                    ${item.xTweetId ? `<a href="https://x.com/i/status/${item.xTweetId}" target="_blank" class="sheet-link">üê¶ Tweet</a>` : ''}
                </td>
                <td class="action-cell" data-label="Aktionen">
                    <button class="btn" onclick="runAction(${item.nr}, 'upload')" ${item.youtubeId || !item.hasMp4 ? 'disabled' : ''} title="Upload to YouTube">
                        YT Short
                    </button>
                    <button class="btn btn-refresh" onclick="runAction(${item.nr}, 'refresh')" ${!item.youtubeId ? 'disabled' : ''} title="Refresh YouTube Metadata">
                        YT Ref
                    </button>
                    <button class="btn ${item.xMediaId ? 'btn-x-ref' : 'btn-x-post'}" 
                            onclick="runAction(${item.nr}, 'x_post')" 
                            ${item.xTweetId || !item.hasMp4 ? 'disabled' : ''} 
                            title="${item.xMediaId ? 'X Video wird noch verarbeitet - klicken zum Pr√ºfen' : 'Post to X (Twitter)'}">
                        ${item.xMediaId ? 'X Ref' : 'X Post'}
                    </button>
                </td>
            </tr>`;
                });

                content.innerHTML = html + '</tbody></table>';

                if (scrolled) {
                    document.getElementById('next-video').scrollIntoView({ behavior: 'auto', block: 'center' });
                }

            } catch (e) { content.innerHTML = "Fehler beim Laden: " + e.message; }
        }

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            // Allow HTML in message if needed, but usually innerText is safer. 
            // Here we changed the p to div in HTML structure above, so let's stick to innerHTML if we want formatting, or innerText.
            // But 'showModal' is legacy. Let's support both.
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('upload-password').value = '';
        }

        async function showDetails(nr) {
            const projectId = getProjectId();
            if (!projectId) return;

            const overlay = document.getElementById('wide-modal-overlay');
            const title = document.getElementById('wide-modal-title');
            const body = document.getElementById('wide-modal-body');
            const confirmBtn = document.getElementById('wide-modal-confirm');

            title.innerText = `Details #${nr}`;
            body.innerHTML = '<p>Laden...</p>';
            confirmBtn.style.display = 'none';
            overlay.style.display = 'flex';

            try {
                const res = await fetch(`list.php?project=${projectId}&detaillevel=full&startnr=${nr}&endnr=${nr}`);
                const json = await res.json();

                if (!json.success || !json.data || json.data.length === 0) {
                    body.innerHTML = '<p style="color:red;">Fehler: Keine Daten gefunden.</p>';
                    return;
                }

                const item = json.data[0];
                body.innerHTML = `
                    <div class="preview-item">
                        <div class="preview-field">
                            <div class="preview-label">Titel</div>
                            <div class="preview-val">${item.titel}</div>
                        </div>
                        <div class="preview-field">
                            <div class="preview-label">Key-Info</div>
                            <div class="preview-val">${item.keyInfo || '(leer)'}</div>
                        </div>
                        <div class="preview-field">
                            <div class="preview-label">Final</div>
                            <div class="preview-val">${item.final || '(leer)'}</div>
                        </div>
                        <div class="preview-field">
                            <div class="preview-label">Infos</div>
                            <div class="preview-val">${item.infos || '(leer)'}</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                body.innerHTML = `<p style="color:red;">Fehler: ${e.message}</p>`;
            }
        }

        async function getAuthHash() {
            let hash = localStorage.getItem('upload_pw_hash');
            if (hash) return hash;

            return new Promise((resolve) => {
                const modal = document.getElementById('password-modal');
                const input = document.getElementById('upload-password');
                const btn = document.getElementById('confirm-upload-btn');

                modal.style.display = 'flex';
                input.focus();

                const handler = async () => {
                    const password = input.value;
                    if (!password) return;

                    const hashed = await sha256(password);
                    localStorage.setItem('upload_pw_hash', hashed);

                    closePasswordModal();
                    document.getElementById('logout-btn').style.display = 'block';

                    btn.removeEventListener('click', handler);
                    input.removeEventListener('keydown', keyHandler);
                    resolve(hashed);
                };

                const keyHandler = (e) => {
                    if (e.key === 'Enter') handler();
                };

                btn.addEventListener('click', handler);
                input.addEventListener('keydown', keyHandler);
            });
        }

        async function initiateBulkAction(type, specificId = null) {
            // 1. Checks
            let ids = [];
            if (specificId) {
                ids = [specificId.toString()];
            } else {
                const checked = document.querySelectorAll('.video-checkbox:checked');
                ids = Array.from(checked).map(cb => cb.value);
            }
            if (ids.length === 0) return;

            const hash = await getAuthHash();
            if (!hash) return;

            const projectId = getProjectId();
            if (!projectId) return;

            // 2. Preview Phase
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            document.getElementById('status-text').innerText = "Generiere Preview...";

            const isX = (type === 'x_post');
            const endpoint = isX ? 'x_post.php' : (type === 'refresh' ? 'refresh.php' : 'upload.php');



            let html = "";
            let atLeastOneSuccess = false;

            for (let i = 0; i < ids.length; i++) {
                const nr = ids[i];
                try {
                    const fd = new FormData();
                    fd.append('video_num', nr);
                    fd.append('password', hash);
                    fd.append('project', projectId);
                    fd.append('preview', 'true');

                    const res = await fetch(endpoint, { method: 'POST', body: fd });
                    const data = await res.json();

                    if (data.success && data.preview) {
                        atLeastOneSuccess = true;

                        if (isX) {
                            // Render Tweet Style
                            const tweetText = (data.full_text || "").replace(/#(\w+)/g, '<span style="color:#1d9bf0">#$1</span>');

                            html += `<div class="preview-item">
                                <div class="preview-header">Video #${data.videoNum} Preview (X Post)</div>
                                <div class="tweet-card">
                                    <div class="tweet-header">
                                        <div class="tweet-avatar"></div>
                                        <div class="tweet-names">
                                            <span class="tweet-name">Bitcoin Shorty</span>
                                            <span class="tweet-handle">@ShortyApp</span>
                                        </div>
                                    </div>
                                    <div class="tweet-body">${tweetText}</div>
                                    <div class="tweet-media">
                                        ${data.driveLink ?
                                    `<video src="${data.driveLink}" controls style="max-width:100%; max-height:300px;"></video>` :
                                    `<div style="padding:20px; color:#536471;">(Video nicht verf√ºgbar)</div>`
                                }
                                    </div>
                                     ${data.driveLink ? `<div style="margin-top:5px; font-size:0.8rem;"><a href="${data.driveLink}" target="_blank" class="tweet-link">Direktlink zum Video (Drive)</a></div>` : ''}
                                    <div class="tweet-actions-mock">
                                        <span>üí¨</span><span>Example</span><span>‚ù§Ô∏è</span><span>‚¨ÜÔ∏è</span>
                                    </div>
                                </div>
                            </div>`;

                        } else {
                            // Render YouTube Style (Standard List)
                            html += `<div class="preview-item">
                                <div class="preview-header">Video #${data.videoNum} Preview (YouTube)</div>`;

                            if (data.driveLink) {
                                const linkLabel = (type === 'refresh' || data.isRefresh) ? 'üìΩÔ∏è Video Link (YouTube)' : 'üìΩÔ∏è Video Link (Drive)';
                                html += `<div class="preview-field"><a href="${data.driveLink}" target="_blank" style="color:#3182ce; font-weight:bold;">${linkLabel}</a></div>`;
                            } else {
                                html += `<div class="preview-field" style="color:red;">Link nicht gefunden</div>`;
                            }

                            if (data.title) {
                                html += `<div class="preview-field"><div class="preview-label">Titel</div><div class="preview-val">${data.title}</div></div>`;
                            }
                            if (data.desc) {
                                html += `<div class="preview-field"><div class="preview-label">Beschreibung</div><div class="preview-val" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${data.desc}</div></div>`;
                            }
                            if (data.tags) {
                                html += `<div class="preview-field"><div class="preview-label">Tags</div><div class="preview-val">${Array.isArray(data.tags) ? data.tags.join(', ') : data.tags}</div></div>`;
                            }

                            // New metadata fields in a grid layout
                            const hasMetadata = data.categoryName || data.languageName || data.privacyStatusName || data.publishDateDisplay || data.containsSyntheticMediaName;
                            if (hasMetadata) {
                                html += `<div class="preview-metadata">`;

                                if (data.categoryName) {
                                    const categoryInfo = data.isRefresh && data.currentCategoryName ?
                                        `${data.categoryName} <span style="color: #718096; font-size: 0.85em;">(aktuell: ${data.currentCategoryName})</span>` :
                                        data.categoryName;
                                    html += `<div class="preview-field"><div class="preview-label">Kategorie</div><div class="preview-val">${categoryInfo}</div></div>`;
                                }
                                if (data.languageName) {
                                    html += `<div class="preview-field"><div class="preview-label">Sprache</div><div class="preview-val">${data.languageName}</div></div>`;
                                }
                                if (data.privacyStatusName) {
                                    html += `<div class="preview-field"><div class="preview-label">Sichtbarkeit</div><div class="preview-val">${data.privacyStatusName}</div></div>`;
                                }
                                if (data.publishDateDisplay) {
                                    html += `<div class="preview-field"><div class="preview-label">Ver√∂ffentlichung</div><div class="preview-val">${data.publishDateDisplay}</div></div>`;
                                }
                                if (data.containsSyntheticMediaName !== undefined) {
                                    html += `<div class="preview-field"><div class="preview-label">Ver√§nderte Inhalte</div><div class="preview-val">${data.containsSyntheticMediaName}</div></div>`;
                                }

                                html += `</div>`;
                            }

                            html += `</div>`;
                        }

                    } else {
                        html += `<div class="preview-item" style="color:red;">Fehler bei Video #${nr}: ${data.message}</div>`;
                    }

                } catch (e) {
                    html += `<div class="preview-item" style="color:red;">Netzwerkfehler bei Video #${nr}</div>`;
                }
            }

            overlay.style.display = 'none';
            document.getElementById('wide-modal-title').innerText = (isX ? 'X (Twitter)' : 'YouTube') + ' Vorschau';
            document.getElementById('wide-modal-body').innerHTML = html;

            // Setup Confirm Button
            const confirmBtn = document.getElementById('wide-modal-confirm');

            if (!atLeastOneSuccess) {
                confirmBtn.style.display = 'none';
            } else {
                confirmBtn.style.display = 'inline-block';
                // Remove old listeners to avoid stacking
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

                newBtn.addEventListener('click', () => {
                    document.getElementById('wide-modal-overlay').style.display = 'none';
                    executeBulkAction(type, ids, hash, projectId);
                });
            }

            document.getElementById('wide-modal-overlay').style.display = 'flex';
        }

        async function executeBulkAction(type, ids, hash, projectId) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            let hasError = false;

            for (let i = 0; i < ids.length; i++) {
                const nr = ids[i];
                document.getElementById('status-text').innerText = `[${i + 1}/${ids.length}] Video #${nr} wird ausgef√ºhrt...`;

                try {
                    const fd = new FormData();
                    fd.append('video_num', nr);
                    fd.append('password', hash);
                    fd.append('project', projectId);

                    const endpointMap = {
                        'upload': 'upload.php',
                        'refresh': 'refresh.php',
                        'x_post': 'x_post.php'
                    };
                    const res = await fetch(endpointMap[type], { method: 'POST', body: fd });
                    const data = await res.json();

                    if (!data.success) {
                        let errorMsg = `Fehler bei Video #${nr}: ${data.message}`;
                        if (data.details && data.details.length > 0) {
                            errorMsg += '<br><br><strong>Details:</strong><br>' + data.details.join('<br>');
                        }
                        if (data.file && data.line) {
                            errorMsg += `<br><br><em>${data.file}:${data.line}</em>`;
                        }
                        if (data.trace && data.trace.length > 0) {
                            errorMsg += '<br><br><strong>Trace:</strong><br><small>' + data.trace.join('<br>') + '</small>';
                        }
                        showModal("Abbruch", errorMsg);
                        hasError = true;
                        break;
                    }
                } catch (e) {
                    showModal("Netzwerkfehler", `Abbruch bei Video #${nr}: ${e.message}`);
                    hasError = true;
                    break;
                }
            }

            overlay.style.display = 'none';
            deselectAll();
            loadData();

            if (!hasError) {
                showModal("Fertig", "Aktion abgeschlossen.");
            }
        }




        async function runAction(nr, type) {
            // Unified flow: use initiateBulkAction for single item too
            initiateBulkAction(type, nr);
        }

        init();
    </script>
</body>

</html>