<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorty Dashboard v3.1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f4f7f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
        }

        th {
            background: #2d3748;
            color: white;
            font-weight: 600;
        }

        .row-done {
            background-color: #f0fff4;
            opacity: 0.8;
        }

        .row-next {
            background-color: #fffaf0 !important;
            border: 2px solid #ed8936;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }

        .bg-ok {
            background: #c6f6d5;
            color: #22543d;
        }

        .bg-err {
            background: #fed7d7;
            color: #822727;
        }

        .btn {
            cursor: pointer;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #3182ce;
            color: white;
            font-weight: bold;
            transition: background 0.2s;
            font-size: 0.85rem;
        }

        .btn:hover {
            background: #2b6cb0;
        }

        .btn-refresh {
            background: #38a169;
        }

        .btn-refresh:hover {
            background: #2f855a;
        }

        .btn:disabled {
            background: #cbd5e0 !important;
            color: #718096 !important;
            cursor: not-allowed;
        }

        .btn-x-post {
            background: #000;
        }

        .btn-x-post:hover:not(:disabled) {
            background: #333;
        }

        .btn-x-ref {
            background: #3182ce;
        }

        .btn-x-ref:hover:not(:disabled) {
            background: #2b6cb0;
        }

        .action-cell {
            display: flex;
            gap: 5px;
        }

        .bulk-actions {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .bulk-actions span {
            font-weight: bold;
            color: #4a5568;
        }

        .bulk-actions .btn-x {
            background: #000;
            color: white;
        }

        .bulk-actions .btn-x:hover {
            background: #333;
        }

        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-logout {
            background: #e53e3e;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-logout:hover {
            background: #c53030;
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .info-cell {
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .links-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .links-cell a {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Mobile Optimierungen */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0;
            }

            .header-area {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 15px;
            }

            .bulk-actions {
                flex-direction: column;
                position: static;
                gap: 10px;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                display: none;
            }

            tr {
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 15px;
                background: white !important;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            td:before {
                display: none;
            }

            td {
                border-bottom: none;
                padding: 4px 0;
                display: block;
                text-align: center;
            }

            /* Verstecke Spalten auf Mobile */
            td[data-label="Nr"],
            td[data-label="Auswahl"],
            .checkbox-col {
                display: none;
            }

            .action-cell {
                display: flex !important;
                flex-direction: row !important;
                gap: 5px;
                padding-top: 10px !important;
                justify-content: center;
                margin-top: 5px;
                border-top: 1px solid #edf2f7;
            }

            .action-cell .btn {
                flex: 1;
                width: auto;
                padding: 8px 2px;
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Datum auf Mobile dezenter */
            td[data-label="Datum"] {
                font-size: 0.85rem;
                color: #4a5568;
            }

            /* Titel prominenter */
            td[data-label="Titel"] {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                font-size: 1.15rem;
                margin-bottom: 5px;
            }

            td[data-label="Titel"]:before {
                margin-bottom: 5px;
            }

            .modal-content {
                width: 90%;
                padding: 20px;
            }
        }

        .yt-link {
            color: #e53e3e;
            font-weight: bold;
            text-decoration: none;
        }

        .sheet-link {
            color: #2b6cb0;
            text-decoration: none;
        }

        .sheet-link:hover {
            text-decoration: underline;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .modal-close {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #2b6cb0;
        }

        #password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(3px);
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <h2 id="status-text">Upload l√§uft...</h2>
        <p>Bitte das Tab nicht schlie√üen.</p>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Hinweis</h2>
            <p id="modal-message"></p>
            <button class="modal-close" onclick="closeModal()">OK</button>
        </div>
    </div>

    <div id="password-modal">
        <div class="modal-content">
            <h2>üîë Autorisierung</h2>
            <p>Bitte Passwort f√ºr Upload eingeben:</p>
            <input type="password" id="upload-password" class="password-input" placeholder="Passwort...">
            <div class="btn-group">
                <button class="modal-close btn-cancel" onclick="closePasswordModal()">Abbrechen</button>
                <button class="modal-close" id="confirm-upload-btn">Upload starten</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-area">
            <h1>üöÄ Bitcoin Jahr 2026 Manager</h1>
            <button class="btn btn-logout" id="logout-btn" style="display:none;" onclick="logout()">Logout / PW
                l√∂schen</button>
        </div>

        <div class="bulk-actions" id="bulk-bar" style="display:none;">
            <span id="selected-count">0 Videos ausgew√§hlt</span>
            <button class="btn" onclick="runBulkAction('upload')">Bulk YT Short</button>
            <button class="btn btn-refresh" onclick="runBulkAction('refresh')">Bulk YouTube Refresh</button>
            <button class="btn btn-x" onclick="runBulkAction('x_post')">Bulk X Post</button>
            <button class="btn btn-cancel" onclick="deselectAll()" style="padding: 8px 12px;">Auswahl aufheben</button>
        </div>

        <div id="content">Daten werden geladen...</div>
    </div>

    <script>
        // Helper: SHA-256 Hash erzeugen
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function logout() {
            localStorage.removeItem('upload_pw_hash');
            location.reload();
        }

        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.video-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkBar();
        }

        function deselectAll() {
            document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateBulkBar();
        }

        function updateBulkBar() {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const bar = document.getElementById('bulk-bar');
            const countLabel = document.getElementById('selected-count');

            if (checked.length > 0) {
                bar.style.display = 'flex';
                countLabel.innerText = `${checked.length} Video(s) ausgew√§hlt`;
            } else {
                bar.style.display = 'none';
            }
        }

        async function loadData() {
            const content = document.getElementById('content');
            try {
                const response = await fetch('list.php');
                const json = await response.json();

                // Logout Button anzeigen wenn Passwort gespeichert
                document.getElementById('logout-btn').style.display = localStorage.getItem('upload_pw_hash') ? 'block' : 'none';

                const nextPending = [...json.data].reverse().find(item => !item.isUploaded);
                let scrolled = false;

                let html = `<table><thead><tr>
                    <th class="checkbox-col"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                    <th>Nr</th><th>Titel (Sheet)</th><th>Info / Dateien</th><th>Links</th><th>Aktion</th>
                </tr></thead><tbody>`;

                json.data.forEach(item => {
                    const isDone = item.isUploaded;
                    const isNext = nextPending && item.nr === nextPending.nr;
                    if (isNext) scrolled = true;

                    const mp4Badge = item.hasMp4
                        ? `<a href="${item.mp4Link}" target="_blank" class="badge bg-ok">MP4 ‚úî</a>`
                        : `<span class="badge bg-err">MP4 ‚úò</span>`;

                    const srtBadge = item.hasSrt
                        ? `<a href="${item.srtLink}" target="_blank" class="badge bg-ok">SRT ‚úî</a>`
                        : `<span class="badge bg-err">SRT ‚úò</span>`;

                    html += `<tr class="${isDone ? 'row-done' : (isNext ? 'row-next' : '')}" ${isNext ? 'id="next-video"' : ''}>
                <td class="checkbox-col" data-label="Auswahl"><input type="checkbox" class="video-checkbox" value="${item.nr}" onchange="updateBulkBar()"></td>
                <td data-label="Nr"><strong>#${item.nr}</strong></td>
                <td data-label="Titel"><a href="${item.sheetLink}" target="_blank" class="sheet-link">${item.titel}</a></td>
                <td data-label="Info" class="info-cell">
                    <div>${item.datum}</div>
                    <div style="margin-top:4px;">${mp4Badge} ${srtBadge}</div>
                </td>
                <td data-label="Links" class="links-cell">
                    ${item.youtubeId ? `<a href="https://youtu.be/${item.youtubeId}" target="_blank" class="yt-link">üé¨ Video</a>` : ''}
                    ${item.xTweetId ? `<a href="https://x.com/i/status/${item.xTweetId}" target="_blank" class="sheet-link">üê¶ Tweet</a>` : ''}
                </td>
                <td class="action-cell" data-label="Aktionen">
                    <button class="btn" onclick="runAction(${item.nr}, 'upload')" ${item.youtubeId || !item.hasMp4 ? 'disabled' : ''} title="Upload to YouTube">
                        YT Short
                    </button>
                    <button class="btn btn-refresh" onclick="runAction(${item.nr}, 'refresh')" ${!item.youtubeId ? 'disabled' : ''} title="Refresh YouTube Metadata">
                        YT Ref
                    </button>
                    <button class="btn ${item.xMediaId ? 'btn-x-ref' : 'btn-x-post'}" 
                            onclick="runAction(${item.nr}, 'x_post')" 
                            ${item.xTweetId || !item.hasMp4 ? 'disabled' : ''} 
                            title="${item.xMediaId ? 'X Video wird noch verarbeitet - klicken zum Pr√ºfen' : 'Post to X (Twitter)'}">
                        ${item.xMediaId ? 'X Ref' : 'X Post'}
                    </button>
                </td>
            </tr>`;
                });

                content.innerHTML = html + '</tbody></table>';

                if (scrolled) {
                    document.getElementById('next-video').scrollIntoView({ behavior: 'auto', block: 'center' });
                }

            } catch (e) { content.innerHTML = "Fehler beim Laden: " + e.message; }
        }

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('upload-password').value = '';
        }

        async function getAuthHash() {
            let hash = localStorage.getItem('upload_pw_hash');
            if (hash) return hash;

            return new Promise((resolve) => {
                const modal = document.getElementById('password-modal');
                const input = document.getElementById('upload-password');
                const btn = document.getElementById('confirm-upload-btn');

                modal.style.display = 'flex';
                input.focus();

                const handler = async () => {
                    const password = input.value;
                    if (!password) return;

                    const hashed = await sha256(password);
                    localStorage.setItem('upload_pw_hash', hashed);

                    closePasswordModal();
                    document.getElementById('logout-btn').style.display = 'block';

                    btn.removeEventListener('click', handler);
                    input.removeEventListener('keydown', keyHandler);
                    resolve(hashed);
                };

                const keyHandler = (e) => {
                    if (e.key === 'Enter') handler();
                };

                btn.addEventListener('click', handler);
                input.addEventListener('keydown', keyHandler);
            });
        }

        async function runBulkAction(type) {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            if (ids.length === 0) return;

            const hash = await getAuthHash();
            if (!hash) return;

            // Bulk Execution one by one
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            for (let i = 0; i < ids.length; i++) {
                const nr = ids[i];
                document.getElementById('status-text').innerText = `[${i + 1}/${ids.length}] Video #${nr} wird verarbeitet...`;

                try {
                    const fd = new FormData();
                    fd.append('video_num', nr);
                    fd.append('password', hash);
                    const endpointMap = {
                        'upload': 'upload.php',
                        'refresh': 'refresh.php',
                        'x_post': 'x_post.php'
                    };
                    const res = await fetch(endpointMap[type], { method: 'POST', body: fd });
                    const data = await res.json();

                    if (!data.success) {
                        showModal("Abbruch w√§hrend Bulk", `Fehler bei Video #${nr}: ` + data.message);
                        break;
                    }
                } catch (e) {
                    showModal("Netzwerkfehler", `Abbruch bei Video #${nr}`);
                    break;
                }
            }

            overlay.style.display = 'none';
            deselectAll();
            loadData();
            showModal("Bulk Fertig", `${ids.length} Videos wurden verarbeitet.`);
        }

        async function runAction(nr, type) {
            const hash = await getAuthHash();
            if (!hash) return;
            executeAction(nr, hash, type);
        }

        async function executeAction(nr, hash, type) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            const actionText = {
                'upload': 'wird an YouTube √ºbertragen...',
                'refresh': 'Metadaten werden aktualisiert...',
                'x_post': 'wird auf X gepostet...'
            };
            document.getElementById('status-text').innerText = `Video #${nr} ${actionText[type]}`;

            try {
                const fd = new FormData();
                fd.append('video_num', nr);
                fd.append('password', hash);

                const endpointMap = {
                    'upload': 'upload.php',
                    'refresh': 'refresh.php',
                    'x_post': 'x_post.php'
                };
                const res = await fetch(endpointMap[type], { method: 'POST', body: fd });
                const data = await res.json();

                if (data.success) {
                    showModal("Erfolg!", data.message || `Video #${nr} wurde verarbeitet.`);
                    loadData();
                } else {
                    showModal("Fehler", data.message);
                    if (data.message.includes("Passwort")) {
                        localStorage.removeItem('upload_pw_hash');
                        location.reload();
                    }
                }
            } catch (e) {
                showModal("Fehler", "Netzwerkfehler oder Server-Timeout.");
            } finally {
                overlay.style.display = 'none';
            }
        }

        loadData();
    </script>
</body>

</html>