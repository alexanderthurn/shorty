<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Shorty Dashboard v3.1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f4f7f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
        }

        th {
            background: #2d3748;
            color: white;
            font-weight: 600;
        }

        .row-done {
            background-color: #f0fff4;
            opacity: 0.8;
        }

        .row-next {
            background-color: #fffaf0 !important;
            border: 2px solid #ed8936;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }

        .bg-ok {
            background: #c6f6d5;
            color: #22543d;
        }

        .bg-err {
            background: #fed7d7;
            color: #822727;
        }

        .btn {
            cursor: pointer;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #3182ce;
            color: white;
            font-weight: bold;
            transition: background 0.2s;
            font-size: 0.85rem;
        }

        .btn:hover {
            background: #2b6cb0;
        }

        .btn-refresh {
            background: #38a169;
        }

        .btn-refresh:hover {
            background: #2f855a;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .action-cell {
            display: flex;
            gap: 5px;
        }

        .bulk-actions {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .bulk-actions span {
            font-weight: bold;
            color: #4a5568;
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .yt-link {
            color: #e53e3e;
            font-weight: bold;
            text-decoration: none;
        }

        .sheet-link {
            color: #2b6cb0;
            text-decoration: none;
        }

        .sheet-link:hover {
            text-decoration: underline;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            color: #333;
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .modal-close {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #2b6cb0;
        }

        #password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(3px);
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <h2 id="status-text">Upload lÃ¤uft...</h2>
        <p>Bitte das Tab nicht schlieÃŸen.</p>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Hinweis</h2>
            <p id="modal-message"></p>
            <button class="modal-close" onclick="closeModal()">OK</button>
        </div>
    </div>

    <div id="password-modal">
        <div class="modal-content">
            <h2>ðŸ”‘ Autorisierung</h2>
            <p>Bitte Passwort fÃ¼r Upload eingeben:</p>
            <input type="password" id="upload-password" class="password-input" placeholder="Passwort...">
            <div class="btn-group">
                <button class="modal-close btn-cancel" onclick="closePasswordModal()">Abbrechen</button>
                <button class="modal-close" id="confirm-upload-btn">Upload starten</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>ðŸš€ Bitcoin Jahr 2026 Manager</h1>

        <div class="bulk-actions" id="bulk-bar" style="display:none;">
            <span id="selected-count">0 Videos ausgewÃ¤hlt</span>
            <button class="btn" onclick="runBulkAction('upload')">Bulk Upload</button>
            <button class="btn btn-refresh" onclick="runBulkAction('refresh')">Bulk Refresh</button>
            <button class="btn btn-cancel" onclick="deselectAll()" style="padding: 8px 12px;">Auswahl aufheben</button>
        </div>

        <div id="content">Daten werden geladen...</div>
    </div>

    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.video-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkBar();
        }

        function deselectAll() {
            document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateBulkBar();
        }

        function updateBulkBar() {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const bar = document.getElementById('bulk-bar');
            const countLabel = document.getElementById('selected-count');

            if (checked.length > 0) {
                bar.style.display = 'flex';
                countLabel.innerText = `${checked.length} Video(s) ausgewÃ¤hlt`;
            } else {
                bar.style.display = 'none';
            }
        }

        async function loadData() {
            const content = document.getElementById('content');
            try {
                const response = await fetch('list.php');
                const json = await response.json();

                const nextPending = [...json.data].reverse().find(item => !item.isUploaded);
                let scrolled = false;

                let html = `<table><thead><tr>
                    <th class="checkbox-col"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                    <th>Nr</th><th>Titel (Sheet)</th><th>Plan-Datum</th><th>Drive-Files</th><th>YouTube</th><th>Aktion</th>
                </tr></thead><tbody>`;

                json.data.forEach(item => {
                    const isDone = item.isUploaded;
                    const isNext = nextPending && item.nr === nextPending.nr;
                    if (isNext) scrolled = true;

                    const mp4Badge = item.hasMp4
                        ? `<a href="${item.mp4Link}" target="_blank" class="badge bg-ok">MP4 âœ”</a>`
                        : `<span class="badge bg-err">MP4 âœ˜</span>`;

                    const srtBadge = item.hasSrt
                        ? `<a href="${item.srtLink}" target="_blank" class="badge bg-ok">SRT âœ”</a>`
                        : `<span class="badge bg-err">SRT âœ˜</span>`;

                    html += `<tr class="${isDone ? 'row-done' : (isNext ? 'row-next' : '')}" ${isNext ? 'id="next-video"' : ''}>
                <td class="checkbox-col"><input type="checkbox" class="video-checkbox" value="${item.nr}" onchange="updateBulkBar()"></td>
                <td><strong>#${item.nr}</strong></td>
                <td><a href="${item.sheetLink}" target="_blank" class="sheet-link">${item.titel}</a></td>
                <td>${item.datum}</td>
                <td>${mp4Badge} ${srtBadge}</td>
                <td>
                    ${item.youtubeId ? `<a href="https://youtu.be/${item.youtubeId}" target="_blank" class="yt-link">ðŸŽ¬ Video</a>` : 'Ausstehend'}
                </td>
                <td class="action-cell">
                    <button class="btn" onclick="runAction(${item.nr}, 'upload')" ${item.youtubeId || !item.hasMp4 ? 'disabled' : ''}>
                        YT Upload
                    </button>
                    <button class="btn btn-refresh" onclick="runAction(${item.nr}, 'refresh')" ${!item.youtubeId ? 'disabled' : ''}>
                        YT Refresh
                    </button>
                </td>
            </tr>`;
                });

                content.innerHTML = html + '</tbody></table>';

                if (scrolled) {
                    document.getElementById('next-video').scrollIntoView({ behavior: 'auto', block: 'center' });
                }

            } catch (e) { content.innerHTML = "Fehler beim Laden: " + e.message; }
        }

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('upload-password').value = '';
        }

        function runBulkAction(type) {
            const checked = document.querySelectorAll('.video-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            if (ids.length === 0) return;

            const modal = document.getElementById('password-modal');
            const input = document.getElementById('upload-password');
            const btn = document.getElementById('confirm-upload-btn');

            modal.style.display = 'flex';
            input.focus();

            btn.onclick = async () => {
                const password = input.value;
                if (!password) return;
                closePasswordModal();

                // Bulk Execution one by one
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = 'flex';

                for (let i = 0; i < ids.length; i++) {
                    const nr = ids[i];
                    document.getElementById('status-text').innerText = `[${i + 1}/${ids.length}] Video #${nr} wird verarbeitet...`;

                    try {
                        const fd = new FormData();
                        fd.append('video_num', nr);
                        fd.append('password', password);
                        const endpoint = type === 'upload' ? 'upload.php' : 'refresh.php';

                        const res = await fetch(endpoint, { method: 'POST', body: fd });
                        const data = await res.json();

                        if (!data.success) {
                            showModal("Abbruch wÃ¤hrend Bulk", `Fehler bei Video #${nr}: ` + data.message);
                            break;
                        }
                    } catch (e) {
                        showModal("Netzwerkfehler", `Abbruch bei Video #${nr}`);
                        break;
                    }
                }

                overlay.style.display = 'none';
                deselectAll();
                loadData();
                showModal("Bulk Fertig", `${ids.length} Videos wurden verarbeitet.`);
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') btn.click();
            };
        }

        function runAction(nr, type) {
            const modal = document.getElementById('password-modal');
            const input = document.getElementById('upload-password');
            const btn = document.getElementById('confirm-upload-btn');

            modal.style.display = 'flex';
            input.focus();

            btn.onclick = () => {
                const password = input.value;
                if (!password) return;
                closePasswordModal();
                executeAction(nr, password, type);
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') btn.click();
            };
        }

        async function executeAction(nr, password, type) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            const statusText = type === 'upload' ? 'wird an YouTube Ã¼bertragen...' : 'Metadaten werden aktualisiert...';
            document.getElementById('status-text').innerText = `Video #${nr} ${statusText}`;

            try {
                const fd = new FormData();
                fd.append('video_num', nr);
                fd.append('password', password);

                const endpoint = type === 'upload' ? 'upload.php' : 'refresh.php';
                const res = await fetch(endpoint, { method: 'POST', body: fd });
                const data = await res.json();

                if (data.success) {
                    showModal("Erfolg!", data.message || `Video #${nr} wurde verarbeitet.`);
                    loadData();
                } else {
                    showModal("Fehler", data.message);
                }
            } catch (e) {
                showModal("Fehler", "Netzwerkfehler oder Server-Timeout.");
            } finally {
                overlay.style.display = 'none';
            }
        }

        loadData();
    </script>
</body>

</html>